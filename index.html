<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML æ‰˜ç®¡å¹³å° - é¢„è§ˆç‰ˆ</title>
    <style>
        :root { --sidebar-width: 300px; --primary: #2563eb; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: system-ui, sans-serif; overflow: hidden; }
        
        .layout { display: flex; height: 100vh; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: var(--sidebar-width); background: #f8fafc; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #e2e8f0; background: white; }
        .sidebar-header h1 { font-size: 1.25rem; margin: 0; color: #0f172a; }
        
        .nav-list { flex: 1; overflow-y: auto; padding: 10px; }
        .nav-item { padding: 12px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; color: #475569; transition: all 0.2s; border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; }
        .nav-item:hover { background: #e2e8f0; color: #0f172a; }
        .nav-item.active { background: white; color: var(--primary); border-color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .upload-btn { margin: 15px; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-align: center; }

        /* ä¸»æ˜¾ç¤ºåŒº */
        .main-content { flex: 1; background: #fff; display: flex; flex-direction: column; position: relative; }
        iframe { border: none; width: 100%; height: 100%; flex: 1; background: #fff; }
        
        .welcome { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #94a3b8; text-align: center; padding: 20px; }
        .welcome h2 { color: #475569; margin-bottom: 10px; }

        /* ä¸Šä¼ å¼¹çª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 5px; }
        input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #e2e8f0; color: #475569; border: none; padding: 10px; flex: 1; border-radius: 6px; cursor: pointer; }
        .btn-submit { background: var(--primary); color: white; border: none; padding: 10px; flex: 2; border-radius: 6px; cursor: pointer; }

        #config-banner { background: #fffbeb; border-bottom: 1px solid #fef3c7; padding: 10px 20px; font-size: 13px; color: #92400e; display: flex; justify-content: space-between; align-items: center; }
        #config-banner button { background: none; border: 1px solid #d97706; color: #d97706; padding: 2px 8px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="layout">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>ğŸš€ HTML æ‰˜ç®¡å¹³å°</h1>
        </div>
        
        <div id="config-banner" style="display:none;">
            <span>éœ€è¦é…ç½® GitHub Token ä»¥åŠ è½½åˆ—è¡¨</span>
            <button onclick="showConfig()">è®¾ç½®</button>
        </div>

        <button class="upload-btn" onclick="showUploadModal()">+ ä¸Šä¼ æ–°é¡µé¢</button>
        
        <div class="nav-list" id="appList">
            <div style="text-align:center; padding: 20px; color: #94a3b8;">æ­£åœ¨åŠ è½½å†…å®¹...</div>
        </div>
    </div>

    <!-- ä¸»æ˜¾ç¤ºåŒº -->
    <div class="main-content">
        <div id="preview-area" style="height: 100%;">
            <div class="welcome" id="welcome-msg">
                <h2>ğŸ” å†…å®¹æ£€æŸ¥å™¨</h2>
                <p>ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªé¡µé¢è¿›è¡Œé¢„è§ˆ</p>
                <p style="font-size: 13px;">(æ–°ä¸Šä¼ çš„é¡µé¢å¯èƒ½éœ€è¦ 1 åˆ†é’Ÿå·¦å³æ‰èƒ½åœ¨è¿™é‡Œé¢„è§ˆ)</p>
            </div>
            <iframe id="preview-iframe" style="display:none;"></iframe>
        </div>
    </div>
</div>

<!-- ä¸Šä¼ å¼¹çª— -->
<div class="modal" id="uploadModal">
    <div class="modal-content">
        <h2 style="margin-top:0;">ğŸ“¤ éƒ¨ç½²æ–°é¡µé¢</h2>
        <div class="form-group">
            <label>åº”ç”¨åç§° (è‹±æ–‡æ–‡ä»¶å¤¹å)</label>
            <input type="text" id="appName" placeholder="ä¾‹å¦‚: my-cool-app">
        </div>
        <div class="form-group">
            <label>HTML æ–‡ä»¶</label>
            <input type="file" id="fileInput" accept=".html">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('uploadModal')">å–æ¶ˆ</button>
            <button class="btn-submit" id="uploadBtn" onclick="handleUpload()">å¼€å§‹éƒ¨ç½²</button>
        </div>
        <p id="upload-status" style="font-size: 12px; margin-top: 10px; color: #2563eb; display:none;"></p>
    </div>
</div>

<!-- é…ç½®å¼¹çª— -->
<div class="modal" id="configModal">
    <div class="modal-content">
        <h2 style="margin-top:0;">âš™ï¸ é…ç½® Token</h2>
        <p style="font-size: 13px; color: #64748b;">ä¸ºäº†åˆ—å‡ºä½ çš„æ‰€æœ‰åº”ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ä½ çš„ GitHub PATã€‚</p>
        <div class="form-group">
            <label>GitHub Token (PAT)</label>
            <input type="password" id="ghToken" placeholder="github_pat_...">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('configModal')">å…³é—­</button>
            <button class="btn-submit" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<script>
    const OWNER = 'wanbitcrp-source';
    const REPO = 'static-pages';
    let currentToken = localStorage.getItem('gh_token') || '';

    // åˆå§‹åŒ–åŠ è½½
    window.onload = () => {
        if (!currentToken) {
            document.getElementById('config-banner').style.display = 'flex';
        }
        loadAppList();
    };

    function showUploadModal() { document.getElementById('uploadModal').style.display = 'flex'; }
    function showConfig() { document.getElementById('configModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function saveConfig() {
        const token = document.getElementById('ghToken').value;
        if (token) {
            localStorage.setItem('gh_token', token);
            currentToken = token;
            closeModal('configModal');
            document.getElementById('config-banner').style.display = 'none';
            loadAppList();
        }
    }

    async function loadAppList() {
        const listContainer = document.getElementById('appList');
        
        // å³ä½¿æ²¡æœ‰ Tokenï¼Œä¹Ÿæ˜¾ç¤ºåŸºç¡€çš„ä¸¤ä¸ªï¼ˆç¡¬ç¼–ç å…œåº•ï¼‰
        const fallbackApps = [
            { name: 'calculator', title: 'ğŸ”¢ åœ¨çº¿è®¡ç®—å™¨' },
            { name: 'kinship', title: 'ğŸ§§ äº²æˆšç§°å‘¼æŸ¥è¯¢' }
        ];

        try {
            if (!currentToken) throw new Error('No token');

            const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/`, {
                headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            
            if (!res.ok) throw new Error('API failed');
            
            const contents = await res.json();
            const folders = contents
                .filter(item => item.type === 'dir' && item.name !== 'skills' && item.name !== 'memory')
                .map(item => ({ name: item.name, title: `ğŸ“¦ ${item.name}` }));

            renderList(folders.length > 0 ? folders : fallbackApps);
        } catch (e) {
            renderList(fallbackApps);
            if (!currentToken) document.getElementById('config-banner').style.display = 'flex';
        }
    }

    function renderList(apps) {
        const listContainer = document.getElementById('appList');
        listContainer.innerHTML = '';
        apps.forEach(app => {
            const div = document.createElement('div');
            div.className = 'nav-item';
            div.innerHTML = `<span>${app.title}</span> <span style="font-size:12px; opacity:0.5">ã€‰</span>`;
            div.onclick = () => previewApp(app.name, div);
            listContainer.appendChild(div);
        });
    }

    function previewApp(name, element) {
        // æ›´æ–° UI é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // åŠ è½½ Iframe
        const iframe = document.getElementById('preview-iframe');
        const welcome = document.getElementById('welcome-msg');
        
        welcome.style.display = 'none';
        iframe.style.display = 'block';
        iframe.src = `./${name}/index.html`;
    }

    async function handleUpload() {
        const appName = document.getElementById('appName').value.trim();
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('upload-status');
        const btn = document.getElementById('uploadBtn');

        if (!currentToken || !appName || !fileInput.files[0]) {
            alert('è¯·æ£€æŸ¥æ˜¯å¦å¡«å†™äº†åç§°ã€é€‰æ‹©äº†æ–‡ä»¶å¹¶é…ç½®äº† Token');
            if(!currentToken) showConfig();
            return;
        }

        btn.disabled = true;
        status.innerText = 'ğŸš€ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...';
        status.style.display = 'block';

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            const content = e.target.result.split(',')[1];
            try {
                const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${appName}/index.html`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Deploy ${appName}`,
                        content: content
                    })
                });

                if (res.ok) {
                    status.innerText = 'âœ… éƒ¨ç½²æˆåŠŸï¼æ­£åœ¨åˆ·æ–°åˆ—è¡¨...';
                    setTimeout(() => {
                        closeModal('uploadModal');
                        loadAppList();
                        status.style.display = 'none';
                        btn.disabled = false;
                    }, 1500);
                } else {
                    const err = await res.json();
                    throw new Error(err.message);
                }
            } catch (err) {
                status.innerText = 'âŒ é”™è¯¯: ' + err.message;
                btn.disabled = false;
            }
        };
        reader.readAsDataURL(file);
    }
</script>

</body>
</html>